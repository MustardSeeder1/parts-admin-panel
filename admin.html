<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parts Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Basic styling for usability */
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
        input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
        button { padding: 10px 15px; cursor: pointer; }
        #login-section, #admin-section { border: 1px solid #ccc; padding: 20px; margin-top: 20px; }
        #admin-section { display: none; } /* Hide admin panel initially */
    </style>
</head>
<body>

    <h1>Parts Admin Panel</h1>

    <div id="login-section">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="login-btn">Login</button>
    </div>

    <div id="admin-section">
        <h2>Add a New Part</h2>
        <input type="text" id="part-name" placeholder="Part Name">
        <input type="text" id="part-number" placeholder="Part Number">
        <textarea id="part-description" placeholder="Description"></textarea>
        <input type="number" id="part-price" placeholder="Price">
        <input type="number" id="part-stock" placeholder="Stock Quantity">
        <label for="part-image">Part Image:</label>
        <input type="file" id="part-image" accept="image/*">
        <button id="add-part-btn">Add Part</button>
        <hr>
        <button id="logout-btn">Logout</button>
    </div>

   <script>
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // <-- Make sure this is still correct
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // <-- Make sure this is still correct

    // FIX: The Supabase library is called 'supabase', so we name our client 'supabaseClient'
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginSection = document.getElementById('login-section');
    const adminSection = document.getElementById('admin-section');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const addPartBtn = document.getElementById('add-part-btn');

    // --- AUTHENTICATION ---
    loginBtn.onclick = async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        // FIX: Use 'supabaseClient'
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) {
            alert('Login failed: ' + error.message);
        } else {
            alert('Login successful!');
            checkUser();
        }
    };

    logoutBtn.onclick = async () => {
        // FIX: Use 'supabaseClient'
        await supabaseClient.auth.signOut();
        checkUser();
    };

    const checkUser = async () => {
        // FIX: Use 'supabaseClient'
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            loginSection.style.display = 'none';
            adminSection.style.display = 'block';
        } else {
            loginSection.style.display = 'block';
            adminSection.style.display = 'none';
        }
    };

    // --- PART MANAGEMENT ---
    addPartBtn.onclick = async () => {
        const name = document.getElementById('part-name').value;
        const part_number = document.getElementById('part-number').value;
        const description = document.getElementById('part-description').value;
        const price = document.getElementById('part-price').value;
        const stock_quantity = document.getElementById('part-stock').value;
        const imageFile = document.getElementById('part-image').files[0];

        if (!name || !price || !imageFile) {
            alert('Name, Price, and Image are required.');
            return;
        }

        addPartBtn.disabled = true;
        addPartBtn.textContent = 'Uploading...';

        // 1. Upload the image
        const fileExt = imageFile.name.split('.').pop();
        const fileName = `${Date.now()}.${fileExt}`;
        const filePath = `${fileName}`;
        
        // FIX: Use 'supabaseClient'
        let { error: uploadError } = await supabaseClient.storage
            .from('part-images')
            .upload(filePath, imageFile);

        if (uploadError) {
            alert('Error uploading image: ' + uploadError.message);
            addPartBtn.disabled = false;
            addPartBtn.textContent = 'Add Part';
            return;
        }

        // 2. Get the public URL of the uploaded image
        // FIX: Use 'supabaseClient'
        const { data: urlData } = supabaseClient.storage
            .from('part-images')
            .getPublicUrl(filePath);

        // 3. Insert the part data into the database
        // FIX: Use 'supabaseClient'
        const { error: insertError } = await supabaseClient
            .from('parts')
            .insert([{
                name: name,
                part_number: part_number,
                description: description,
                price: parseFloat(price),
                stock_quantity: parseInt(stock_quantity),
                image_url: urlData.publicUrl
            }]);
        
        if (insertError) {
            alert('Error adding part: ' + insertError.message);
        } else {
            alert('Part added successfully!');
            // Reset form fields
            document.getElementById('part-name').value = '';
            document.getElementById('part-number').value = '';
            document.getElementById('part-description').value = '';
            document.getElementById('part-price').value = '';
            document.getElementById('part-stock').value = '';
            document.getElementById('part-image').value = null;
        }

        addPartBtn.disabled = false;
        addPartBtn.textContent = 'Add Part';
    };

    // Check user status on page load
    checkUser();
</script>